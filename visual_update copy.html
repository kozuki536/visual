<!DOCTYPE html>
<html>
  <head>
    <title>my experiment</title>
    <script src="https://unpkg.com/jspsych@8.2.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-virtual-chinrest@2.0.3"></script>
    <link href="https://unpkg.com/jspsych@8.2.1/css/jspsych.css" rel="stylesheet" />
    <style>
      body {
        background-color: black;
        color: white;
        cursor: none;
        margin: 0;
        overflow: hidden; /* スクロール防止 */
      }
      .stimulus-container {
        position: relative;
        margin: 0 auto;
        background-color: rgb(153, 153, 153);
      }
      .background-color {
        background-color: white;
        color: black;
        cursor: auto;
      }
    </style>
  </head>
  <body>
    <script>
      const jsPsych = initJsPsych({
        override_safe_mode: true,
        on_finish: function () {
          jsPsych.data.displayData();
        },
      });

      const timeline = [];

      /* ID入力 */
      const get_id = {
        type: jsPsychSurveyHtmlForm,
        preamble: "<p>IDを入力してください</p>",
        html: '<input type="text" name="participant_id" required>',
        css_classes: "background-color",
        on_finish: function (data) {
          const responses = JSON.parse(data.responses);
          jsPsych.data.addProperties({ participant_id: responses.participant_id });
        },
      };
      timeline.push(get_id);

      /* 顎台 */
      const chinrest = {
        type: jsPsychVirtualChinrest,
        blindspot_reps: 3,
        resize_units: "deg",
        pixels_per_unit: 25,
        css_classes: "background-color",
        on_finish: function (data) {
          jsPsych.data.addProperties({
            px_per_deg: data.px_per_unit,
          });
        },
      };
      timeline.push(chinrest);

      /* preload */
      const preload = {
        type: jsPsychPreload,
        images: ["img/target_T.png", "img/distractor_L.png"],
      };
      timeline.push(preload);

      /* 説明 */
      timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <p>「T」があったら「F」キーを、なければ「J」キーを押してください。</p>
          <p>できるだけ早く、正確に反応してください。</p>
          <p>任意のキーで開始します。</p>`,
      });

      // ==== 自動スケール関数 ====
      function getDisplayParams(px_per_deg) {
        const displayDeg = { width: 25.39, height: 19.05 };
        let width = displayDeg.width * px_per_deg;
        let height = displayDeg.height * px_per_deg;

        // ウィンドウサイズに収まるようにスケーリング
        const maxWidth = window.innerWidth * 0.9;
        const maxHeight = window.innerHeight * 0.9;
        const scale = Math.min(maxWidth / width, maxHeight / height, 1);

        return {
          px_per_deg: px_per_deg,
          width: width * scale,
          height: height * scale,
          scale: scale,
        };
      }

      /* ノイズ背景 */
      function generateNoiseBackground(width, height, density = 0.4) {
        const canvas = document.createElement("canvas");
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");
        const numNoisePixels = Math.round(width * height * density);

        for (let i = 0; i < numNoisePixels; i++) {
          const x = Math.floor(Math.random() * width);
          const y = Math.floor(Math.random() * height);
          const color = 35;
          ctx.fillStyle = `rgb(${color}, ${color}, ${color})`;
          ctx.fillRect(x, y, 1, 1);
        }
        return canvas.toDataURL();
      }

      /* 固視点 */
      function FixationStimulus() {
        const px_per_deg =
          jsPsych.data.get().filter({ trial_type: "virtual-chinrest" }).values()[0]
            ?.px_per_unit || 25;

        const params = getDisplayParams(px_per_deg);
        const sizepx = 0.5 * px_per_deg * params.scale;

        return `
          <div class="stimulus-container" style="width:${params.width}px; height:${params.height}px;">
            <div style="font-size:${sizepx}px; color:gray; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);">+</div>
          </div>`;
      }

      const fixation = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: FixationStimulus,
        choices: "NO-KEYS",
        trial_duration: 1000,
      };

      /* 試行定義 */
      const trialList = [];
      for (let i = 0; i < 36; i++) {
        trialList.push({ hasTarget: true });
        trialList.push({ hasTarget: false });
      }
      const shuffledTrials = jsPsych.randomization.shuffle(trialList);

      for (let i = 0; i < shuffledTrials.length; i++) {
        const hasTarget = shuffledTrials[i].hasTarget;

        timeline.push(fixation);

        timeline.push({
          type: jsPsychHtmlKeyboardResponse,
          stimulus: function () {
            const px_per_deg =
              jsPsych.data.get().filter({ trial_type: "virtual-chinrest" }).values()[0]
                ?.px_per_unit || 25;
            const params = getDisplayParams(px_per_deg);

            // 論文の値
            const stimSizeDeg = 0.95;
            const cellSizeDeg = 3.17;
            const jitterSizeDeg = 0.79;

            // px変換
            const stimSizePx = stimSizeDeg * px_per_deg * params.scale;
            const cellSizePx = cellSizeDeg * px_per_deg * params.scale;
            const jitterSizePx = jitterSizeDeg * px_per_deg * params.scale;

            const cols = 8;
            const rows = 6;

            const valid_positions = [];
            const center_row = Math.floor(rows / 2);
            const center_col = Math.floor(cols / 2);

            for (let row = 0; row < rows; row++) {
              for (let col = 0; col < cols; col++) {
                const isCenter =
                  (col === center_col || col === center_col - 1) &&
                  (row === center_row || row === center_row - 1);
                if (!isCenter) valid_positions.push([col, row]);
              }
            }

            const shuffle_positions = jsPsych.randomization.shuffle(valid_positions);
            const selected_positions = shuffle_positions.slice(0, 16);
            const targetIndex = hasTarget ? Math.floor(Math.random() * 16) : -1;

            const noiseBackground = generateNoiseBackground(
              params.width,
              params.height,
              0.4
            );

            let html = `<div class="stimulus-container" style="width:${params.width}px; height:${params.height}px; background-image:url(${noiseBackground}); background-size:cover;">`;

            for (let j = 0; j < 16; j++) {
              const [col, row] = selected_positions[j];
              const x =
                col * cellSizePx +
                (cellSizePx - stimSizePx) / 2 +
                (Math.random() * 2 * jitterSizePx - jitterSizePx);
              const y =
                row * cellSizePx +
                (cellSizePx - stimSizePx) / 2 +
                (Math.random() * 2 * jitterSizePx - jitterSizePx);
              const angle = [0, 90, 180, 270][Math.floor(Math.random() * 4)];
              const img = j === targetIndex ? "img/target_T.png" : "img/distractor_L.png";

              html += `<img src="${img}" style="position:absolute; width:${stimSizePx}px; height:${stimSizePx}px; left:${x}px; top:${y}px; transform:rotate(${angle}deg); transform-origin:center;">`;
            }

            html += "</div>";
            return html;
          },
          choices: ["f", "j"],
          trial_duration: 10000,
          data: {
            hasTarget: hasTarget,
            correct_response: hasTarget ? "f" : "j",
          },
          on_finish(data) {
            data.correct = data.response === data.correct_response;
          },
        });
      }

      /* データ保存 */
      const save_data = {
        type: jsPsychPipe,
        action: "save",
        experiment_id: "6VlTDkZAkqjx",
        filename: () => {
          const id =
            jsPsych.data.get().values()[0].participant_id ||
            jsPsych.randomization.randomID(10);
          return `${id}.csv`;
        },
        data_string: () => jsPsych.data.get().csv(),
      };
      timeline.push(save_data);

      jsPsych.run(timeline);
    </script>
  </body>
</html>
